import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import picaLib from 'pica';
import * as i0 from "@angular/core";
import * as i1 from "./img-exif.service";
const pica = picaLib();
const globalWindow = window;
export class Ng2PicaService {
    constructor(imageExifService) {
        this.imageExifService = imageExifService;
    }
    resize(files, width, height, keepAspectRatio = false) {
        let resizedFile = new Subject();
        for (let i = 0; i < files.length; i++) {
            this.resizeFile(files[i], width, height, keepAspectRatio).then((returnedFile) => {
                resizedFile.next(returnedFile);
            }).catch((error) => {
                resizedFile.error(error);
            });
        }
        return resizedFile.asObservable();
    }
    resizeCanvas(from, to, options) {
        let result = new Promise((resolve, reject) => {
            let curPica = pica;
            if (!curPica || !curPica.resize) {
                curPica = new globalWindow.pica();
            }
            curPica.resize(from, to, options)
                .then((response) => {
                resolve(response);
            }, (error) => {
                reject(error);
            });
        });
        return result;
    }
    resizeBuffer(options) {
        let result = new Promise((resolve, reject) => {
            let curPica = pica;
            if (!curPica || !curPica.resizeBuffer) {
                curPica = new globalWindow.pica();
            }
            curPica.resizeBuffer(options)
                .then((response) => {
                resolve(response);
            }, (error) => {
                reject(error);
            });
        });
        return result;
    }
    resizeFile(file, width, height, keepAspectRatio = false) {
        let result = new Promise((resolve, reject) => {
            let fromCanvas = document.createElement('canvas');
            let ctx = fromCanvas.getContext('2d');
            let img = new Image();
            img.onload = () => {
                this.imageExifService.getOrientedImage(img).then(orientedImg => {
                    globalWindow.URL.revokeObjectURL(img.src);
                    fromCanvas.width = orientedImg.width;
                    fromCanvas.height = orientedImg.height;
                    ctx?.drawImage(orientedImg, 0, 0);
                    let imageData = ctx?.getImageData(0, 0, orientedImg.width, orientedImg.height);
                    if (keepAspectRatio && imageData) {
                        let ratio = Math.min(width / imageData.width, height / imageData.height);
                        width = Math.round(imageData.width * ratio);
                        height = Math.round(imageData.height * ratio);
                    }
                    let useAlpha = true;
                    if (file.type === "image/jpeg" || (file.type === "image/png" && !this.isImgUsingAlpha(imageData))) {
                        //image without alpha
                        useAlpha = false;
                        ctx = fromCanvas.getContext('2d', { 'alpha': false });
                        ctx?.drawImage(orientedImg, 0, 0);
                    }
                    let toCanvas = document.createElement('canvas');
                    toCanvas.width = width;
                    toCanvas.height = height;
                    this.resizeCanvas(fromCanvas, toCanvas, { 'alpha': useAlpha })
                        .then((resizedCanvas) => {
                        resizedCanvas.toBlob((blob) => {
                            if (!blob) {
                                return reject('error blob');
                            }
                            let newFile = this.generateResultFile(blob, file.name, file.type, new Date().getTime());
                            resolve(newFile);
                        }, file.type);
                    })
                        .catch((error) => {
                        reject(error);
                    });
                });
            };
            img.src = globalWindow.URL.createObjectURL(file);
        });
        return result;
    }
    isImgUsingAlpha(imageData) {
        for (var i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i + 3] !== 255) {
                return true;
            }
        }
        return false;
    }
    generateResultFile(blob, name, type, lastModified) {
        let resultFile = new Blob([blob], { type: type });
        return this.blobToFile(resultFile, name, lastModified);
    }
    blobToFile(blob, name, lastModified) {
        let file = blob;
        file.name = name;
        file.lastModified = lastModified;
        //Cast to a File() type
        return file;
    }
}
Ng2PicaService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: Ng2PicaService, deps: [{ token: i1.ImgExifService }], target: i0.ɵɵFactoryTarget.Injectable });
Ng2PicaService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: Ng2PicaService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: Ng2PicaService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.ImgExifService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmcyLXBpY2Euc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvbmcyLXBpY2Euc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBYSxPQUFPLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFFekMsT0FBTyxPQUFPLE1BQU0sTUFBTSxDQUFDOzs7QUFFM0IsTUFBTSxJQUFJLEdBQUksT0FBZSxFQUFFLENBQUM7QUFDaEMsTUFBTSxZQUFZLEdBQVEsTUFBTSxDQUFDO0FBMEJqQyxNQUFNLE9BQU8sY0FBYztJQUN6QixZQUFvQixnQkFBZ0M7UUFBaEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFnQjtJQUNwRCxDQUFDO0lBRU0sTUFBTSxDQUFDLEtBQWEsRUFBRSxLQUFhLEVBQUUsTUFBYyxFQUFFLGtCQUEyQixLQUFLO1FBQzFGLElBQUksV0FBVyxHQUFrQixJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ3JELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUU7Z0JBQzlFLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDakMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7Z0JBQ2pCLFdBQVcsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDM0IsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3BDLENB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RUFBRSxZQUFZLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU8sVUFBVSxDQUFDLElBQVUsRUFBRSxJQUFZLEVBQUUsWUFBb0I7UUFDL0QsSUFBSSxJQUFJLEdBQVEsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBRWpDLHVCQUF1QjtRQUN2QixPQUFhLElBQUksQ0FBQztJQUNwQixDQUFDOzsyR0F0SFUsY0FBYzsrR0FBZCxjQUFjLGNBRmIsTUFBTTsyRkFFUCxjQUFjO2tCQUgxQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZSwgU3ViamVjdH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7SW1nRXhpZlNlcnZpY2V9IGZyb20gJy4vaW1nLWV4aWYuc2VydmljZSc7XHJcbmltcG9ydCBwaWNhTGliIGZyb20gJ3BpY2EnO1xyXG5cclxuY29uc3QgcGljYSA9IChwaWNhTGliIGFzIGFueSkoKTtcclxuY29uc3QgZ2xvYmFsV2luZG93OiBhbnkgPSB3aW5kb3c7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFJlc2l6ZUNhbnZhc09wdGlvbnMge1xyXG4gIHF1YWxpdHk/OiBudW1iZXI7XHJcbiAgYWxwaGE/OiBib29sZWFuO1xyXG4gIHVuc2hhcnBBbW91bnQ/OiBudW1iZXI7XHJcbiAgdW5zaGFycFJhZGl1cz86IG51bWJlcjtcclxuICB1bnNoYXJwVGhyZXNob2xkPzogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFJlc2l6ZUJ1ZmZlck9wdGlvbnMge1xyXG4gIHNyYzogVWludDhBcnJheTtcclxuICB3aWR0aDogbnVtYmVyO1xyXG4gIGhlaWdodDogbnVtYmVyO1xyXG4gIHRvV2lkdGg6IG51bWJlcjtcclxuICB0b0hlaWdodDogbnVtYmVyO1xyXG4gIHF1YWxpdHk/OiBudW1iZXI7XHJcbiAgYWxwaGE/OiBib29sZWFuO1xyXG4gIHVuc2hhcnBBbW91bnQ/OiBudW1iZXI7XHJcbiAgdW5zaGFycFJhZGl1cz86IG51bWJlcjtcclxuICB1bnNoYXJwVGhyZXNob2xkPzogbnVtYmVyO1xyXG59XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOZzJQaWNhU2VydmljZSB7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbWFnZUV4aWZTZXJ2aWNlOiBJbWdFeGlmU2VydmljZSkge1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2l6ZShmaWxlczogRmlsZVtdLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwga2VlcEFzcGVjdFJhdGlvOiBib29sZWFuID0gZmFsc2UpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgbGV0IHJlc2l6ZWRGaWxlOiBTdWJqZWN0PEZpbGU+ID0gbmV3IFN1YmplY3Q8RmlsZT4oKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgdGhpcy5yZXNpemVGaWxlKGZpbGVzW2ldLCB3aWR0aCwgaGVpZ2h0LCBrZWVwQXNwZWN0UmF0aW8pLnRoZW4oKHJldHVybmVkRmlsZSkgPT4ge1xyXG4gICAgICAgIHJlc2l6ZWRGaWxlLm5leHQocmV0dXJuZWRGaWxlKTtcclxuICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgcmVzaXplZEZpbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXNpemVkRmlsZS5hc09ic2VydmFibGUoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyByZXNpemVDYW52YXMoZnJvbTogSFRNTENhbnZhc0VsZW1lbnQsIHRvOiBIVE1MQ2FudmFzRWxlbWVudCwgb3B0aW9uczogUmVzaXplQ2FudmFzT3B0aW9ucyk6IFByb21pc2U8SFRNTENhbnZhc0VsZW1lbnQ+IHtcclxuICAgIGxldCByZXN1bHQ6IFByb21pc2U8SFRNTENhbnZhc0VsZW1lbnQ+ID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBsZXQgY3VyUGljYSA9IHBpY2E7XHJcbiAgICAgIGlmICghY3VyUGljYSB8fCAhY3VyUGljYS5yZXNpemUpIHtcclxuICAgICAgICBjdXJQaWNhID0gbmV3IGdsb2JhbFdpbmRvdy5waWNhKCk7XHJcbiAgICAgIH1cclxuICAgICAgY3VyUGljYS5yZXNpemUoZnJvbSwgdG8sIG9wdGlvbnMpXHJcbiAgICAgICAgLnRoZW4oKHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSk7XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2l6ZUJ1ZmZlcihvcHRpb25zOiBSZXNpemVCdWZmZXJPcHRpb25zKTogUHJvbWlzZTxVaW50OEFycmF5PiB7XHJcbiAgICBsZXQgcmVzdWx0OiBQcm9taXNlPFVpbnQ4QXJyYXk+ID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBsZXQgY3VyUGljYSA9IHBpY2E7XHJcbiAgICAgIGlmICghY3VyUGljYSB8fCAhY3VyUGljYS5yZXNpemVCdWZmZXIpIHtcclxuICAgICAgICBjdXJQaWNhID0gbmV3IGdsb2JhbFdpbmRvdy5waWNhKCk7XHJcbiAgICAgIH1cclxuICAgICAgY3VyUGljYS5yZXNpemVCdWZmZXIob3B0aW9ucylcclxuICAgICAgICAudGhlbigocmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlc2l6ZUZpbGUoZmlsZTogRmlsZSwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIsIGtlZXBBc3BlY3RSYXRpbzogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxGaWxlPiB7XHJcbiAgICBsZXQgcmVzdWx0OiBQcm9taXNlPEZpbGU+ID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBsZXQgZnJvbUNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcclxuICAgICAgbGV0IGN0eCA9IGZyb21DYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcclxuICAgICAgbGV0IGltZyA9IG5ldyBJbWFnZSgpO1xyXG4gICAgICBpbWcub25sb2FkID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuaW1hZ2VFeGlmU2VydmljZS5nZXRPcmllbnRlZEltYWdlKGltZykudGhlbihvcmllbnRlZEltZyA9PiB7XHJcbiAgICAgICAgICBnbG9iYWxXaW5kb3cuVVJMLnJldm9rZU9iamVjdFVSTChpbWcuc3JjKTtcclxuICAgICAgICAgIGZyb21DYW52YXMud2lkdGggPSBvcmllbnRlZEltZy53aWR0aDtcclxuICAgICAgICAgIGZyb21DYW52YXMuaGVpZ2h0ID0gb3JpZW50ZWRJbWcuaGVpZ2h0O1xyXG4gICAgICAgICAgY3R4Py5kcmF3SW1hZ2Uob3JpZW50ZWRJbWcsIDAsIDApO1xyXG4gICAgICAgICAgbGV0IGltYWdlRGF0YSA9IGN0eD8uZ2V0SW1hZ2VEYXRhKDAsIDAsIG9yaWVudGVkSW1nLndpZHRoLCBvcmllbnRlZEltZy5oZWlnaHQpO1xyXG4gICAgICAgICAgaWYgKGtlZXBBc3BlY3RSYXRpbyAmJiBpbWFnZURhdGEpIHtcclxuICAgICAgICAgICAgbGV0IHJhdGlvID0gTWF0aC5taW4od2lkdGggLyBpbWFnZURhdGEud2lkdGgsIGhlaWdodCAvIGltYWdlRGF0YS5oZWlnaHQpO1xyXG4gICAgICAgICAgICB3aWR0aCA9IE1hdGgucm91bmQoaW1hZ2VEYXRhLndpZHRoICogcmF0aW8pO1xyXG4gICAgICAgICAgICBoZWlnaHQgPSBNYXRoLnJvdW5kKGltYWdlRGF0YS5oZWlnaHQgKiByYXRpbyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBsZXQgdXNlQWxwaGEgPSB0cnVlO1xyXG4gICAgICAgICAgaWYgKGZpbGUudHlwZSA9PT0gXCJpbWFnZS9qcGVnXCIgfHwgKGZpbGUudHlwZSA9PT0gXCJpbWFnZS9wbmdcIiAmJiAhdGhpcy5pc0ltZ1VzaW5nQWxwaGEoaW1hZ2VEYXRhKSkpIHtcclxuICAgICAgICAgICAgLy9pbWFnZSB3aXRob3V0IGFscGhhXHJcbiAgICAgICAgICAgIHVzZUFscGhhID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGN0eCA9IGZyb21DYW52YXMuZ2V0Q29udGV4dCgnMmQnLCB7J2FscGhhJzogZmFsc2V9KTtcclxuICAgICAgICAgICAgY3R4Py5kcmF3SW1hZ2Uob3JpZW50ZWRJbWcsIDAsIDApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgbGV0IHRvQ2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xyXG4gICAgICAgICAgdG9DYW52YXMud2lkdGggPSB3aWR0aDtcclxuICAgICAgICAgIHRvQ2FudmFzLmhlaWdodCA9IGhlaWdodDtcclxuICAgICAgICAgIHRoaXMucmVzaXplQ2FudmFzKGZyb21DYW52YXMsIHRvQ2FudmFzLCB7J2FscGhhJzogdXNlQWxwaGF9KVxyXG4gICAgICAgICAgICAudGhlbigocmVzaXplZENhbnZhczogSFRNTENhbnZhc0VsZW1lbnQpID0+IHtcclxuICAgICAgICAgICAgICByZXNpemVkQ2FudmFzLnRvQmxvYigoYmxvYikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFibG9iKSB7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoJ2Vycm9yIGJsb2InKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbGV0IG5ld0ZpbGU6IEZpbGUgPSB0aGlzLmdlbmVyYXRlUmVzdWx0RmlsZShibG9iLCBmaWxlLm5hbWUsIGZpbGUudHlwZSwgbmV3IERhdGUoKS5nZXRUaW1lKCkpO1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShuZXdGaWxlKTtcclxuICAgICAgICAgICAgICB9LCBmaWxlLnR5cGUpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgaW1nLnNyYyA9IGdsb2JhbFdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGUpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc0ltZ1VzaW5nQWxwaGEoaW1hZ2VEYXRhOiBhbnkpOiBib29sZWFuIHtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW1hZ2VEYXRhLmRhdGEubGVuZ3RoOyBpICs9IDQpIHtcclxuICAgICAgaWYgKGltYWdlRGF0YS5kYXRhW2kgKyAzXSAhPT0gMjU1KSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2VuZXJhdGVSZXN1bHRGaWxlKGJsb2I6IEJsb2IsIG5hbWU6IHN0cmluZywgdHlwZTogc3RyaW5nLCBsYXN0TW9kaWZpZWQ6IG51bWJlcik6IEZpbGUge1xyXG4gICAgbGV0IHJlc3VsdEZpbGUgPSBuZXcgQmxvYihbYmxvYl0sIHt0eXBlOiB0eXBlfSk7XHJcbiAgICByZXR1cm4gdGhpcy5ibG9iVG9GaWxlKHJlc3VsdEZpbGUsIG5hbWUsIGxhc3RNb2RpZmllZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJsb2JUb0ZpbGUoYmxvYjogQmxvYiwgbmFtZTogc3RyaW5nLCBsYXN0TW9kaWZpZWQ6IG51bWJlcik6IEZpbGUge1xyXG4gICAgbGV0IGZpbGU6IGFueSA9IGJsb2I7XHJcbiAgICBmaWxlLm5hbWUgPSBuYW1lO1xyXG4gICAgZmlsZS5sYXN0TW9kaWZpZWQgPSBsYXN0TW9kaWZpZWQ7XHJcblxyXG4gICAgLy9DYXN0IHRvIGEgRmlsZSgpIHR5cGVcclxuICAgIHJldHVybiA8RmlsZT5maWxlO1xyXG4gIH1cclxufVxyXG4iXX0=